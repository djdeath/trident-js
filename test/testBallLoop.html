<html>

<head>
<script type='text/javascript' src='../trident.js'></script>
<script type='text/javascript' src='ballVisualizer.js'></script>

<script>

function Ball() {
  this.radius = 20;
  this.ballY = this.radius;
}

var ball = new Ball();

function draw() {
  var canvas = document.getElementById("ballCanvas");
  if (canvas.getContext) {
    var ctx = canvas.getContext("2d");
    
    var w = canvas.width;
    var h = canvas.height;
    
    ctx.clearRect(0,0,w,h); 
    ctx.beginPath();
    ctx.arc(w/2, ball.ballY, ball.radius, 0, 360, false);

    var radgrad = ctx.createRadialGradient(
      w/2-ball.radius/4, ball.ballY-ball.radius/5, ball.radius/4,
      w/2, ball.ballY, ball.radius);
    radgrad.addColorStop(0, '#00FF00');
    radgrad.addColorStop(1, '#003300');
    ctx.fillStyle = radgrad;
    ctx.fill();
  }
}

function drawVisualizer() {
  var canvas = document.getElementById("visualizerCanvas");
  if (canvas.getContext) {
    var ctx = canvas.getContext("2d");
    
    var w = canvas.width;
    var h = canvas.height;
    
    visualizer.draw(ctx, w, h);
  }
}

var timelineBallFalling;

function run() {
  if (timelineBallFalling != undefined) {
    timelineBallFalling.cancel();
  }
  timelineBallFalling = new Timeline(ball);
  timelineBallFalling.addPropertiesToInterpolate([
    // interpolate the ball Y position
    { property: "ballY", 
      from: ball.radius, 
      to: document.getElementById("ballCanvas").height - ball.radius, 
      interpolator: new IntPropertyInterpolator() }
  ]);
  var drawCallback = function(timeline, durationFraction, timelinePosition) {
    draw();
  }
  var reportStateChange = function(timeline, oldState, newState, durationFraction, timelinePosition) {
    stateTracking.innerHTML += ("From " + oldState + " to " + newState + 
      " at " + timelinePosition + "<br>");
    draw();
  }
  timelineBallFalling.addEventListener("onpulse", drawCallback);
  timelineBallFalling.addEventListener("onstatechange", reportStateChange);

  var visualizerCallback = function(timeline, durationFraction, timelinePosition) {
    visualizer.addDot(durationFraction, timelinePosition);
  }
  timelineBallFalling.addEventListener("onpulse", visualizerCallback);

  timelineBallFalling.duration = 2000;
  timelineBallFalling.initialDelay = document.getElementById("initialDelay").value;
  timelineBallFalling.cycleDelay = document.getElementById("cycleDelay").value;

  var selectedEaseIndex = parseInt(document.getElementById("ease").value);
  var selectedEase;
  switch (selectedEaseIndex) {
    case 1: selectedEase = new LinearEase(); break;
    case 2: selectedEase = new SineEase(); break;
    case 3: selectedEase = new SplineEase(0.1, 0.0, 0.9, 1.0); break;
    case 4: selectedEase = new SplineEase(0.2, 0.0, 0.8, 1.0); break;
    case 5: selectedEase = new SplineEase(0.5, 0.0, 0.5, 1.0); break;
    case 6: selectedEase = new SplineEase(0.8, 0.0, 0.2, 1.0); break;
    case 7: selectedEase = new SplineEase(0.9, 0.0, 0.1, 1.0); break;
    case 8: selectedEase = new SplineEase(1.0, 0.0, 0.0, 1.0); break;
  }
  timelineBallFalling.ease = selectedEase;

  var msToSkip = parseInt(document.getElementById("toSkip").value);
  if (msToSkip == 0) {
    timelineBallFalling.playInfiniteLoop(RepeatBehavior.REVERSE);
  } else {
    timelineBallFalling.playInfiniteLoopSkipping(RepeatBehavior.REVERSE, msToSkip);
  }
}

function cancel() {
  if (timelineBallFalling != undefined) {
    timelineBallFalling.cancelAtCycleBreak();
  }
}

function suspend() {
  if (timelineBallFalling != undefined) {
    timelineBallFalling.suspend();
  }
}

function resume() {
  if (timelineBallFalling != undefined) {
    timelineBallFalling.resume();
  }
}

</script>

</head>

<body onload="draw(); drawVisualizer();">
  <canvas id="ballCanvas" width="400" height="200"></canvas><br>
  <canvas id="visualizerCanvas" width="400" height="200"></canvas><br>
  
  Initial delay:
  <input id="initialDelay" value="0"><br>
  Cycle delay:
  <input id="cycleDelay" value="0"><br>
  To skip:
  <input id="toSkip" value="0"><br>
  Ease:
  <select id="ease">
  <option value="1">1. Linear</option>
  <option value="2">2. Sine</option>
  <option value="3">3. Spline (0.1, 0.0)-(0.9,1.0)</option>
  <option value="4">4. Spline (0.2, 0.0)-(0.8,1.0)</option>
  <option value="5">5. Spline (0.5, 0.0)-(0.5,1.0)</option>
  <option value="6">6. Spline (0.8, 0.0)-(0.2,1.0)</option>
  <option value="7">7. Spline (0.9, 0.0)-(0.1,1.0)</option>
  <option value="8">8. Spline (1.0, 0.0)-(0.9,1.0)</option>
  </select><br>
  
  <input type="button" name="buttonRun" value="run" onClick="run()">
  <input type="button" name="buttonCancel" value="cancel" onClick="cancel()">
  <input type="button" name="buttonSuspend" value="suspend" onClick="suspend()">
  <input type="button" name="buttonResume" value="resume" onClick="resume()">
  
  <div id="stateTracking"/>
  
  <script>
    var visualizer = new TimelineVisualizer();

    var visualizerRepaintTimeline = new Timeline();
    visualizerRepaintTimeline.addEventListener("onpulse", 
      function(timeline, durationFraction, timelinePosition) {
        drawVisualizer();
      }
    );
    visualizerRepaintTimeline.playInfiniteLoop(RepeatBehavior.REVERSE);

  </script>
</body>

</html>